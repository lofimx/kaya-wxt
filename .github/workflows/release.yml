name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-extension:
    name: Build Extension (${{ matrix.browser }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [firefox, chrome, edge]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: extension
        run: pnpm install

      - name: Zip extension
        working-directory: extension
        run: pnpm wxt zip -b ${{ matrix.browser }}

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.browser }}
          path: extension/.output/*.zip
          include-hidden-files: true

  build-daemon:
    name: Build Daemon (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: savebutton-daemon
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: savebutton-daemon
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: savebutton-daemon
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: savebutton-daemon.exe
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        working-directory: daemon
        run: cargo build --release --target ${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-${{ matrix.target }}
          path: daemon/target/${{ matrix.target }}/release/${{ matrix.binary }}

  package-linux:
    name: Package Linux (${{ matrix.format }})
    needs: build-daemon
    runs-on: ubuntu-latest
    strategy:
      matrix:
        format: [deb, rpm]
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: daemon-x86_64-unknown-linux-gnu
          path: binary

      - name: Make binary executable
        run: chmod +x binary/savebutton-daemon

      - name: Install rpmbuild
        if: matrix.format == 'rpm'
        run: sudo apt-get install -y rpm

      - name: Build package
        run: daemon/packaging/build-${{ matrix.format }}.sh binary/savebutton-daemon

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.format }}
          path: |
            daemon/packaging/build-deb/*.deb
            daemon/packaging/build-rpm/rpmbuild/RPMS/**/*.rpm

  publish-chrome:
    name: Publish to Chrome Web Store
    needs: [build-extension, test-rust, test-extension]
    runs-on: ubuntu-latest
    steps:
      - name: Download Chrome extension
        uses: actions/download-artifact@v4
        with:
          name: extension-chrome
          path: artifacts

      - name: Find zip file
        id: find-zip
        run: echo "zip_path=$(ls artifacts/*-chrome.zip)" >> "$GITHUB_OUTPUT"

      - name: Publish to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: ${{ steps.find-zip.outputs.zip_path }}
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}

  publish-edge:
    name: Publish to Edge Add-ons
    needs: [build-extension, test-rust, test-extension]
    runs-on: ubuntu-latest
    steps:
      - name: Download Edge extension
        uses: actions/download-artifact@v4
        with:
          name: extension-edge
          path: artifacts

      - name: Find zip file
        id: find-zip
        run: echo "zip_path=$(ls artifacts/*-edge.zip)" >> "$GITHUB_OUTPUT"

      - name: Publish to Edge Add-ons
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: ${{ steps.find-zip.outputs.zip_path }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          api-key: ${{ secrets.EDGE_API_KEY }}

  publish-firefox:
    name: Publish to Firefox AMO
    needs: [build-extension, test-rust, test-extension]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: extension
        run: pnpm install

      - name: Download Firefox extension
        uses: actions/download-artifact@v4
        with:
          name: extension-firefox
          path: artifacts

      - name: Find zip files
        id: find-zip
        run: |
          echo "zip_path=$(ls artifacts/*-firefox.zip)" >> "$GITHUB_OUTPUT"
          echo "sources_path=$(ls artifacts/*-sources.zip)" >> "$GITHUB_OUTPUT"

      - name: Sign and publish to AMO
        working-directory: extension
        run: |
          pnpm wxt submit \
            --firefox-zip "$GITHUB_WORKSPACE/${{ steps.find-zip.outputs.zip_path }}" \
            --firefox-sources-zip "$GITHUB_WORKSPACE/${{ steps.find-zip.outputs.sources_path }}" \
            --firefox-extension-id "org.savebutton@savebutton.org" \
            --firefox-jwt-issuer "${{ secrets.AMO_JWT_ISSUER }}" \
            --firefox-jwt-secret "${{ secrets.AMO_JWT_SECRET }}"

  release:
    name: Create Release
    needs:
      [
        build-extension,
        build-daemon,
        package-linux,
        publish-chrome,
        publish-edge,
        publish-firefox,
        publish-safari,
      ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/daemon-*/*

  build-safari:
    name: Build Safari Extension
    needs: [test-rust, test-extension]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: extension
        run: pnpm install

      - name: Build WXT for Safari
        working-directory: extension
        run: pnpm wxt build -b safari

      - name: Install Apple certificate and provisioning profile
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISION_PROFILE_APP_BASE64: ${{ secrets.APPLE_PROVISION_PROFILE_APP_BASE64 }}
          APPLE_PROVISION_PROFILE_EXT_BASE64: ${{ secrets.APPLE_PROVISION_PROFILE_EXT_BASE64 }}
          APP_STORE_API_KEY_BASE64: ${{ secrets.APP_STORE_API_KEY_BASE64 }}
          APP_STORE_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Install provisioning profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo -n "$APPLE_PROVISION_PROFILE_APP_BASE64" | base64 --decode \
            -o ~/Library/MobileDevice/Provisioning\ Profiles/SaveButton_App.provisionprofile
          echo -n "$APPLE_PROVISION_PROFILE_EXT_BASE64" | base64 --decode \
            -o ~/Library/MobileDevice/Provisioning\ Profiles/SaveButton_Ext.provisionprofile

          # Write App Store Connect API key for -allowProvisioningUpdates
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$APP_STORE_API_KEY_BASE64" | base64 --decode \
            -o ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_API_KEY}.p8

      - name: Archive universal binary (arm64 + x86_64)
        env:
          APP_STORE_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
          APP_STORE_API_ISSUER: ${{ secrets.APP_STORE_API_ISSUER }}
        run: |
          cd "safari/Save Button"
          xcodebuild archive \
            -scheme "Save Button (macOS)" \
            -configuration Release \
            -archivePath build/SaveButton-macOS.xcarchive \
            -destination "generic/platform=macOS" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_API_KEY}.p8 \
            -authenticationKeyID "$APP_STORE_API_KEY" \
            -authenticationKeyIssuerID "$APP_STORE_API_ISSUER"

      - name: Export archive for App Store
        env:
          APP_STORE_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
          APP_STORE_API_ISSUER: ${{ secrets.APP_STORE_API_ISSUER }}
        run: |
          cd "safari/Save Button"
          cat > ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
          </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath build/SaveButton-macOS.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_API_KEY}.p8 \
            -authenticationKeyID "$APP_STORE_API_KEY" \
            -authenticationKeyIssuerID "$APP_STORE_API_ISSUER"

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: safari-macOS-archive
          path: safari/Save Button/build/export/*.pkg

      - name: Clean up keychain
        if: always()
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  publish-safari:
    name: Publish to App Store Connect
    needs: build-safari
    runs-on: macos-latest
    steps:
      - name: Download Safari archive
        uses: actions/download-artifact@v4
        with:
          name: safari-macOS-archive
          path: artifacts

      - name: Upload to App Store Connect
        env:
          APP_STORE_API_KEY: ${{ secrets.APP_STORE_API_KEY }}
          APP_STORE_API_ISSUER: ${{ secrets.APP_STORE_API_ISSUER }}
          APP_STORE_API_KEY_BASE64: ${{ secrets.APP_STORE_API_KEY_BASE64 }}
        run: |
          # Write the API key to a file
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$APP_STORE_API_KEY_BASE64" | base64 --decode \
            -o ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_API_KEY}.p8

          PKG_PATH=$(ls artifacts/*.pkg)

          xcrun notarytool submit "$PKG_PATH" \
            --key ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_API_KEY}.p8 \
            --key-id "$APP_STORE_API_KEY" \
            --issuer "$APP_STORE_API_ISSUER" \
            --wait

          xcrun altool --upload-app \
            -f "$PKG_PATH" \
            -t macos \
            --apiKey "$APP_STORE_API_KEY" \
            --apiIssuer "$APP_STORE_API_ISSUER"

  test-rust:
    name: Test Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests
        working-directory: daemon
        run: cargo test

  test-extension:
    name: Test Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: extension
        run: pnpm install

      - name: Build (Firefox)
        working-directory: extension
        run: pnpm wxt build -b firefox

      - name: Build (Chrome)
        working-directory: extension
        run: pnpm wxt build -b chrome
